<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#5e35b1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ë£¨í‹´í‘œ">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='0.9em' font-size='90'%3EğŸŒŸ%3C/text%3E%3C/svg%3E">
    <title>ìš°ë¦¬ ì•„ì´ ì£¼ê°„ ë£¨í‹´í‘œ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Malgun Gothic", sans-serif;
            background: linear-gradient(135deg, #e3f2fd 0%, #e1bee7 100%);
            min-height: 100vh;
            padding: 16px;
            -webkit-tap-highlight-color: transparent;
            padding-bottom: 80px;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        .card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h1 { font-size: 24px; color: #333; margin-bottom: 8px; }
        h2 { font-size: 18px; color: #333; margin-bottom: 12px; }
        .subtitle { color: #666; font-size: 14px; margin-bottom: 16px; }
        
        .routine-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
        }
        .routine-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        .routine-emoji { font-size: 28px; }
        .routine-name { font-size: 16px; font-weight: 600; color: #333; }
        .routine-trigger {
            font-size: 12px;
            color: #666;
            font-style: italic;
            margin-left: 36px;
            margin-bottom: 12px;
        }
        .days-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
        }
        .day-box { text-align: center; }
        .day-label {
            font-size: 12px;
            font-weight: 600;
            color: #5e35b1;
            margin-bottom: 4px;
        }
        .day-btn {
            width: 100%;
            height: 60px;
            border: 2px solid #ddd;
            border-radius: 12px;
            background: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            transition: all 0.2s;
        }
        .day-btn:active { transform: scale(0.95); }
        .day-btn.checked {
            background: #4caf50;
            border-color: #4caf50;
            box-shadow: 0 2px 8px rgba(76,175,80,0.4);
        }
        .day-btn.circle {
            background: #ffc107;
            border-color: #ffc107;
            box-shadow: 0 2px 8px rgba(255,193,7,0.4);
        }
        .day-btn.off {
            background: #e0e0e0;
            border-color: #ccc;
            color: #999;
            cursor: not-allowed;
        }
        
        .section-header {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 12px;
        }
        .morning { background: #fff9c4; color: #f57f17; }
        .afternoon { background: #ffe0b2; color: #e65100; }
        .evening { background: #e1bee7; color: #6a1b9a; }
        
        .activity-btn {
            width: 100%;
            padding: 14px;
            margin-bottom: 8px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            background: white;
            text-align: left;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .activity-btn:active { transform: scale(0.98); }
        .activity-btn.selected {
            background: #ec407a;
            color: white;
            border-color: #ec407a;
        }
        .bridge-btn.selected {
            background: #5e35b1;
            color: white;
            border-color: #5e35b1;
        }
        
        input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            margin-top: 4px;
            margin-bottom: 12px;
        }
        input[type="text"]:focus {
            outline: none;
            border-color: #5e35b1;
        }
        label {
            font-size: 13px;
            font-weight: 600;
            color: #555;
        }
        
        .save-btn {
            width: 100%;
            padding: 14px;
            background: #4caf50;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
        }
        .save-btn:active { opacity: 0.8; }
        
        .popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #4caf50, #2196f3);
            color: white;
            padding: 24px 32px;
            border-radius: 16px;
            font-size: 20px;
            font-weight: bold;
            box-shadow: 0 8px 24px rgba(0,0,0,0.3);
            z-index: 1000;
            display: none;
            animation: bounce 0.5s;
        }
        @keyframes bounce {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.1); }
        }
        
        .recovery-item {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
            font-size: 13px;
            color: #555;
        }
        .recovery-num { font-weight: bold; color: #00acc1; }
        
        @media (min-width: 768px) and (orientation: landscape) {
            .days-grid { gap: 12px; }
            .day-btn { height: 70px; }
            h1 { font-size: 28px; }
            .routine-emoji { font-size: 32px; }
        }
        
        @media (min-width: 768px) {
            .weekend-grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 16px;
            }
        }
        
        .checkmark {
            width: 28px;
            height: 28px;
            stroke: white;
            stroke-width: 4;
            fill: none;
        }
        .circle-icon {
            width: 24px;
            height: 24px;
            border: 4px solid white;
            border-radius: 50%;
        }
        
        .install-prompt {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #5e35b1;
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            display: none;
            z-index: 999;
            max-width: 90%;
            text-align: center;
        }
        .install-btn {
            background: white;
            color: #5e35b1;
            border: none;
            padding: 8px 20px;
            border-radius: 6px;
            font-weight: bold;
            margin-top: 8px;
            margin-right: 8px;
            cursor: pointer;
        }
        .close-btn {
            background: transparent;
            color: white;
            border: 1px solid white;
            padding: 8px 20px;
            border-radius: 6px;
            margin-top: 8px;
            cursor: pointer;
        }
        
        /* Weekly Reset Modal */
        .reset-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }
        .reset-modal.show { display: flex; }
        .reset-content {
            background: white;
            border-radius: 20px;
            padding: 32px;
            max-width: 400px;
            width: 100%;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
        .reset-title {
            font-size: 24px;
            font-weight: bold;
            color: #333;
            margin-bottom: 16px;
        }
        .reset-message {
            font-size: 16px;
            color: #666;
            margin-bottom: 24px;
            line-height: 1.6;
        }
        .reset-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .reset-btn {
            padding: 14px;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .reset-btn:active { transform: scale(0.98); }
        .reset-btn.primary {
            background: #2196f3;
            color: white;
        }
        .reset-btn.danger {
            background: #ff5722;
            color: white;
        }
        .reset-btn.secondary {
            background: #e0e0e0;
            color: #333;
        }
    </style>
</head>
<body>
    <div id="popup" class="popup"></div>
    
    <!-- Weekly Reset Modal -->
    <div id="resetModal" class="reset-modal">
        <div class="reset-content">
            <div class="reset-title">ğŸŒŸ ìƒˆë¡œìš´ ì£¼ê°€ ì‹œì‘ëì–´ìš”!</div>
            <div class="reset-message">
                ì§€ë‚œì£¼ ê¸°ë¡ì„ ì‚­ì œí•˜ê³ <br>
                ìƒˆë¡œ ì‹œì‘í• ê¹Œìš”?<br><br>
                <small style="color: #999;">ğŸ’¡ ë©”ì¼ë¡œ ë³´ë‚´ë©´ ê¸°ë¡ì´ ë³´ê´€ë¼ìš”</small>
            </div>
            <div class="reset-buttons">
                <button class="reset-btn primary" onclick="sendWeeklyEmailFromModal()">
                    ğŸ“§ ë©”ì¼ ë¨¼ì € ë³´ë‚´ê¸°
                </button>
                <button class="reset-btn danger" onclick="resetWeeklyData()">
                    ğŸ”„ ì‚­ì œí•˜ê³  ìƒˆë¡œ ì‹œì‘
                </button>
                <button class="reset-btn secondary" onclick="closeResetModal()">
                    âŒ ì·¨ì†Œ (ê·¸ëŒ€ë¡œ ìœ ì§€)
                </button>
            </div>
        </div>
    </div>
    
    <div id="installPrompt" class="install-prompt">
        <div style="font-size: 16px; font-weight: bold; margin-bottom: 8px;">ğŸ“± í™ˆ í™”ë©´ì— ì¶”ê°€í•˜ê¸°</div>
        <div style="font-size: 13px; margin-bottom: 12px;">ì•±ì²˜ëŸ¼ í¸í•˜ê²Œ ì‚¬ìš©í•˜ì„¸ìš”!</div>
        <button class="install-btn" onclick="installApp()">ì„¤ì¹˜í•˜ê¸°</button>
        <button class="close-btn" onclick="closeInstall()">ë‚˜ì¤‘ì—</button>
    </div>
    
    <div class="container">
        <div class="card">
            <h1>â­ ìš°ë¦¬ ì•„ì´ ì£¼ê°„ ë£¨í‹´í‘œ</h1>
            <div class="subtitle">âœ¨ ê¸ˆìš”ì¼ì€ ì‰¬ëŠ” ë‚ ! í•˜ê³  ì‹¶ìœ¼ë©´ í•˜ê³ , ì•ˆ í•´ë„ ê´œì°®ì•„ìš”.</div>
        </div>

        <div id="monthlyGrowth" class="card" style="display:none; border-left: 4px solid #9c27b0;">
            <h2>ğŸŒ± ì´ë²ˆ ë‹¬ ë‹¬ë¼ì§„ ì </h2>
            <label>1ê°œì›” ì „ì— ë¹„í•´ ë” ì‰¬ì›Œì§„ ê²ƒ:</label>
            <input type="text" id="monthlyEasier">
            <label>ìƒˆë¡œ í•  ìˆ˜ ìˆê²Œ ëœ ê²ƒ:</label>
            <input type="text" id="monthlyNew">
            <label>ë‚˜ë§Œì˜ íŒ:</label>
            <input type="text" id="monthlyTip">
            <button class="save-btn" onclick="saveMonthlyGrowth()">ì €ì¥í•˜ê¸°</button>
        </div>

        <div class="card">
            <h2>ğŸ“… ìš”ì¼ë³„ ë£¨í‹´</h2>
            
            <div class="section-header morning">ğŸŒ… ì•„ì¹¨ ë£¨í‹´</div>
            <div id="morningRoutines"></div>
            
            <div class="section-header afternoon">â˜€ï¸ ì˜¤í›„ ë£¨í‹´</div>
            <div id="afternoonRoutines"></div>
            
            <div class="section-header evening">ğŸŒ™ ì €ë… ë£¨í‹´</div>
            <div id="eveningRoutines"></div>
        </div>

        <div class="card" style="border-left: 4px solid #00bcd4;">
            <h2>ğŸŒ§ï¸ ì˜¤ëŠ˜ ë£¨í‹´ì´ í˜ë“¤ ë•ŒëŠ” ì´ë ‡ê²Œ!</h2>
            <div class="recovery-item">
                <span class="recovery-num">1ï¸âƒ£</span>
                <span><strong>ì˜¤ëŠ˜ ë£¨í‹´ì´ ì•ˆ ë  ë•Œ</strong> â†’ í•˜ë‚˜ë§Œ ê³¨ë¼ì„œ í•˜ê¸°</span>
            </div>
            <div class="recovery-item">
                <span class="recovery-num">2ï¸âƒ£</span>
                <span><strong>ê·¸ê²ƒë„ í˜ë“¤ ë•Œ</strong> â†’ 5ë¶„ë§Œ í•˜ê¸°</span>
            </div>
            <div class="recovery-item">
                <span class="recovery-num">3ï¸âƒ£</span>
                <span><strong>ê·¸ë˜ë„ í˜ë“¤ ë•Œ</strong> â†’ ì²´í¬ ëŒ€ì‹  â­• í‘œì‹œ (í•œ ë²ˆ ë” í´ë¦­)</span>
            </div>
            <div class="recovery-item">
                <span class="recovery-num">4ï¸âƒ£</span>
                <div>
                    <strong>ì™œ í˜ë“¤ì—ˆì„ê¹Œ?</strong><br>
                    <div style="margin-top:8px; padding:12px; background:#f5f5f5; border-radius:8px; font-size:12px;">
                        â–¡ í”¼ê³¤í•´ì„œ<br>
                        â–¡ ì‹œê°„ì´ ì—†ì–´ì„œ<br>
                        â–¡ ì§‘ì¤‘ì´ ì•ˆ ë¼ì„œ<br>
                        â–¡ ê¸°ë¶„ì´ ì•ˆ ì¢‹ì•„ì„œ
                    </div>
                </div>
            </div>
            <div style="margin-top:12px; padding:12px; background:#fff9c4; border-radius:8px; text-align:center; font-weight:600; color:#f57f17;">
                â­•ê°€ ìˆìœ¼ë©´ ì˜¤ëŠ˜ì€ ì„±ê³µ!
            </div>
        </div>

        <div class="weekend-grid">
            <div class="card" style="border-left: 4px solid #ec407a;">
                <h2>âœ¨ í† ìš”ì¼ íŠ¹ë³„ í™œë™</h2>
                <div class="subtitle">ë‘ ê°œê¹Œì§€ ê³¨ë¼ë„ ë¼. ì•ˆ ê³¨ë¼ë„ ì‹¤íŒ¨ ì•„ëƒ!</div>
                <div id="saturdayActivities"></div>
            </div>

            <div class="card" style="border-left: 4px solid #5e35b1;">
                <h2>ğŸŒ‰ ì¼ìš”ì¼ ë¸Œë¦¿ì§€ (10ë¶„)</h2>
                <div class="subtitle">ì´ê±´ ê³µë¶€ ì•„ë‹ˆê³ , ì›”ìš”ì¼ ë¬¸ë§Œ ì—´ì–´ë‘ëŠ” ê±°ì•¼. í•˜ë‚˜ë§Œ ì„ íƒ!</div>
                <div id="sundayBridges"></div>
            </div>
        </div>

        <div class="card" style="border-left: 4px solid #4caf50;">
            <h2>ğŸ’­ ì´ë²ˆ ì£¼ í•œ ë§ˆë”” (ì¼ìš”ì¼ ì„ íƒ)</h2>
            <div class="subtitle">í•œ ì¤„ë§Œ ì¨ë„ OK, ì•ˆ ì¨ë„ ê´œì°®ì•„!</div>
            <label>ì œì¼ ì‰¬ì› ë˜ ê²ƒ:</label>
            <input type="text" id="weeklyEasy" placeholder="ì˜ˆ: ì˜ì–´ ë“£ê¸°">
            <label>í˜ë“¤ì—ˆë˜ ê²ƒ:</label>
            <input type="text" id="weeklyHard" placeholder="ì˜ˆ: ìˆ˜ìš”ì¼ ìˆ˜í•™">
            <label>ë‹¤ìŒ ì£¼ ì‘ì „:</label>
            <input type="text" id="weeklyPlan" placeholder="ì˜ˆ: ìˆ˜í•™ ë¨¼ì € í•˜ê¸°">
            <button class="save-btn" onclick="saveWeeklyReflection()">ì €ì¥í•˜ê¸°</button>
            <button class="save-btn" onclick="sendWeeklyEmail()" style="background: #2196f3; margin-top: 8px;">
                ğŸ“§ ì´ë²ˆ ì£¼ ê¸°ë¡ ë©”ì¼ ë³´ë‚´ê¸°
            </button>
        </div>

        <div class="card" style="background:#e8f5e9; border-left:4px solid #4caf50; text-align:center; color:#2e7d32; font-weight:600;">
            ğŸ’š ì´ ë£¨í‹´í‘œëŠ” ì˜í–ˆëŠ”ì§€ í™•ì¸í•˜ëŠ” í‘œê°€ ì•„ë‹ˆë¼, ë‹¤ìŒ ë‚ ì„ ì‰½ê²Œ ë§Œë“œëŠ” êµ¬ì¡°í‘œì…ë‹ˆë‹¤.
        </div>
    </div>

    <script>
        const days = ['ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ'];
        const routines = {
            morning: [
                { id: 'english', name: 'ì˜ì–´ë„ì„œê´€ 30ë¶„', emoji: 'ğŸ“š', trigger: 'ì•„ì¹¨ë°¥ ë¨¹ìœ¼ë©´ì„œ' },
                { id: 'math', name: 'í•€ë€ë“œìˆ˜í•™ 2í˜ì´ì§€', emoji: 'ğŸ”¢', off: true, trigger: 'ì˜ì–´ ëë‚˜ë©´' },
                { id: 'hanja', name: 'í•œì/ì¼ì¼ì—°ì‚° 2í˜ì´ì§€', emoji: 'âœï¸', off: true, trigger: 'ìˆ˜í•™ ëë‚˜ë©´' }
            ],
            afternoon: [
                { id: 'ort', name: 'ORT ì²­ë… 30ë¶„', emoji: 'ğŸ§', off: true, trigger: 'íƒœê¶Œë„ ë§ˆì¹˜ê³  ê°„ì‹ ë¨¹ê³ ' },
                { id: 'reading', name: 'ì±… ì½ê¸° (ì„ íƒ)', emoji: 'ğŸ“–', trigger: 'ì—„ë§ˆ ì €ë… ì¤€ë¹„í•  ë•Œ' }
            ],
            evening: [
                { id: 'ringfit', name: 'ë§í• 30ë¶„ (ì„ íƒ)', emoji: 'ğŸ®', trigger: 'ì €ë… ë¨¹ê³ ' }
            ]
        };
        
        const saturdayActivities = ['ë³´ë“œê²Œì„ 1íŒ', 'ê·¸ë¦¼ ê·¸ë¦¬ê¸° (ë¬¼ê° ê°€ëŠ¥)', 'ë§Œë“¤ê¸° í™œë™', 'ë„ì„œê´€ ë‹¤ë…€ì˜¤ê¸°', 'ì˜ˆëŠ¥ í”„ë¡œê·¸ë¨ í•¨ê»˜ ë³´ê¸°'];
        const sundayBridges = ['ì˜ì–´ë„ì„œê´€', 'ORT', 'ìˆ˜í•™ ë¬¸ì œ 1ê°œë§Œ', 'ì±… 4í˜ì´ì§€ë§Œ ì½ê¸° (ë” ì½ì–´ë„ ì¢‹ìŒ)'];
        
        const greenMsg = ["ì˜¤ëŠ˜ë„ ë¬¸ ì—´ì–´ë’€ë„¤! ğŸ‘", "ë‚´ì¼ì´ ì‰¬ì›Œì§€ëŠ” ì¤‘!", "ì¢‹ì•„, í•œ ê±¸ìŒ ë”! ğŸš€", "ë£¨í‹´ ë§ˆìŠ¤í„° ë“±ì¥! âœ¨", "ì˜¤ëŠ˜ ì°¸ ì˜í–ˆì–´!", "ì´ê²Œ ë°”ë¡œ ìŠµê´€ì˜ í˜! ğŸ’ª", "ì›”ìš”ì¼ì´ í¸í•´ì§ˆ ê±°ì•¼!", "ë©‹ì§„ë°? ğŸ˜Š", "ê³„ì† ì´ë ‡ê²Œ! ğŸŒŸ", "ë„ˆì˜ ì„ íƒì´ ë§Œë“œëŠ” ë³€í™”!"];
        const yellowMsg = ["ê´œì°®ì•„! ì‹œë„í•œ ê²ƒë§Œìœ¼ë¡œ ì¶©ë¶„í•´! ğŸ’™", "í˜ë“¤ ë• ì´ë ‡ê²Œ! ì˜í–ˆì–´! ğŸŒˆ", "ì˜¤ëŠ˜ì€ ì´ ì •ë„ë©´ ì„±ê³µì´ì•¼! âœ¨", "ì™„ë²½í•˜ì§€ ì•Šì•„ë„ ê´œì°®ì•„! ğŸ‘", "ì¡°ê¸ˆë§Œ í•´ë„ ëŒ€ë‹¨í•œ ê±°ì•¼! ğŸ’ª", "í˜ë“  ë‚ ë„ ìˆëŠ” ê±°ì§€! í™”ì´íŒ…! ğŸŒŸ", "ë…¸ë ¥í–ˆë‹¤ëŠ” ê²Œ ì¤‘ìš”í•´! ğŸ˜Š", "ì´ê²ƒë„ ì„±ê³µì´ì•¼! ğŸ‰", "ë‚´ì¼ì€ ë” ë‚˜ì„ ê±°ì•¼! ğŸŒ±", "ì‹œë„í•œ ê±° ìì²´ê°€ ë©‹ì ¸! ğŸ’š"];
        
        let data = { routines: {}, weekend: [], bridge: '', weekly: {}, monthly: {} };
        let deferredPrompt;
        
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            setTimeout(() => {
                if (!localStorage.getItem('installDismissed')) {
                    document.getElementById('installPrompt').style.display = 'block';
                }
            }, 3000);
        });
        
        function installApp() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then(() => {
                    deferredPrompt = null;
                    document.getElementById('installPrompt').style.display = 'none';
                });
            }
        }
        
        function closeInstall() {
            document.getElementById('installPrompt').style.display = 'none';
            localStorage.setItem('installDismissed', 'true');
        }
        
        function load() {
            const saved = localStorage.getItem('routineData');
            if (saved) data = JSON.parse(saved);
            
            document.getElementById('weeklyEasy').value = data.weekly.easy || '';
            document.getElementById('weeklyHard').value = data.weekly.hard || '';
            document.getElementById('weeklyPlan').value = data.weekly.plan || '';
            document.getElementById('monthlyEasier').value = data.monthly.easier || '';
            document.getElementById('monthlyNew').value = data.monthly.newSkill || '';
            document.getElementById('monthlyTip').value = data.monthly.tip || '';
            
            const today = new Date();
            if (today.getDay() === 0) {
                const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
                if (lastDay - today.getDate() < 7) {
                    document.getElementById('monthlyGrowth').style.display = 'block';
                }
            }
            
            // Check for weekly reset (Monday check)
            checkWeeklyReset();
        }
        
        function checkWeeklyReset() {
            const today = new Date();
            const currentWeek = getWeekNumber(today);
            const lastWeek = localStorage.getItem('lastWeek');
            
            // If it's Monday and a new week
            if (today.getDay() === 1 && lastWeek && lastWeek !== currentWeek) {
                // Show reset modal
                setTimeout(() => {
                    document.getElementById('resetModal').classList.add('show');
                }, 1000);
            }
            
            // Update last week
            localStorage.setItem('lastWeek', currentWeek);
        }
        
        function getWeekNumber(date) {
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            const dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
            return d.getUTCFullYear() + '-W' + weekNo;
        }
        
        function closeResetModal() {
            document.getElementById('resetModal').classList.remove('show');
        }
        
        function resetWeeklyData() {
            if (confirm('ì •ë§ ì§€ë‚œì£¼ ê¸°ë¡ì„ ì‚­ì œí• ê¹Œìš”?\n(ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ì–´ìš”!)')) {
                // Clear routines
                data.routines = {};
                data.weekend = [];
                data.bridge = '';
                data.weekly = {};
                
                save();
                render();
                
                // Clear input fields
                document.getElementById('weeklyEasy').value = '';
                document.getElementById('weeklyHard').value = '';
                document.getElementById('weeklyPlan').value = '';
                
                closeResetModal();
                alert('ìƒˆë¡œìš´ ì£¼ê°€ ì‹œì‘ëì–´ìš”! í™”ì´íŒ…! ğŸŒŸ');
            }
        }
        
        function sendWeeklyEmailFromModal() {
            sendWeeklyEmail();
            setTimeout(() => {
                if (confirm('ë©”ì¼ì„ ë³´ëƒˆë‚˜ìš”?\në³´ëƒˆìœ¼ë©´ "í™•ì¸"ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.')) {
                    closeResetModal();
                }
            }, 1000);
        }
        
        function save() {
            localStorage.setItem('routineData', JSON.stringify(data));
        }
        
        function showMsg(type) {
            const msgs = type === 'green' ? greenMsg : yellowMsg;
            const msg = msgs[Math.floor(Math.random() * msgs.length)];
            const popup = document.getElementById('popup');
            popup.textContent = msg;
            popup.style.display = 'block';
            setTimeout(() => popup.style.display = 'none', 2000);
        }
        
        function toggle(id, day) {
            const key = id + '-' + day;
            const state = data.routines[key] || 'empty';
            
            if (state === 'empty') {
                data.routines[key] = 'checked';
                showMsg('green');
            } else if (state === 'checked') {
                data.routines[key] = 'circle';
                showMsg('yellow');
            } else {
                data.routines[key] = 'empty';
            }
            
            save();
            render();
        }
        
        function createRoutine(r) {
            let html = `<div class="routine-card">
                <div class="routine-header">
                    <span class="routine-emoji">${r.emoji}</span>
                    <span class="routine-name">${r.name}</span>
                </div>
                <div class="routine-trigger">â° ${r.trigger}</div>
                <div class="days-grid">`;
            
            days.forEach((d, i) => {
                const off = r.off && i === 4;
                const state = data.routines[r.id + '-' + d] || 'empty';
                const cls = off ? 'off' : state;
                
                let content = '';
                if (off) content = 'OFF';
                else if (state === 'checked') content = '<svg class="checkmark" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>';
                else if (state === 'circle') content = '<div class="circle-icon"></div>';
                
                html += `<div class="day-box">
                    <div class="day-label">${d}</div>
                    <button class="day-btn ${cls}" ${off ? 'disabled' : `onclick="toggle('${r.id}','${d}')"`}>
                        ${content}
                    </button>
                </div>`;
            });
            
            html += '</div></div>';
            return html;
        }
        
        function render() {
            document.getElementById('morningRoutines').innerHTML = routines.morning.map(createRoutine).join('');
            document.getElementById('afternoonRoutines').innerHTML = routines.afternoon.map(createRoutine).join('');
            document.getElementById('eveningRoutines').innerHTML = routines.evening.map(createRoutine).join('');
            
            document.getElementById('saturdayActivities').innerHTML = saturdayActivities.map(a => 
                `<button class="activity-btn ${data.weekend.includes(a) ? 'selected' : ''}" onclick="toggleWeekend('${a}')">${a}</button>`
            ).join('');
            
            document.getElementById('sundayBridges').innerHTML = sundayBridges.map(b => 
                `<button class="activity-btn bridge-btn ${data.bridge === b ? 'selected' : ''}" onclick="setBridge('${b}')">${b}</button>`
            ).join('');
        }
        
        function toggleWeekend(a) {
            const idx = data.weekend.indexOf(a);
            if (idx > -1) {
                data.weekend.splice(idx, 1);
            } else {
                if (data.weekend.length >= 2) {
                    alert('ë‘ ê°œê¹Œì§€ë§Œ ì„ íƒí•  ìˆ˜ ìˆì–´ìš”! ğŸ˜Š');
                    return;
                }
                data.weekend.push(a);
            }
            save();
            render();
        }
        
        function setBridge(b) {
            data.bridge = data.bridge === b ? '' : b;
            save();
            render();
        }
        
        function saveWeeklyReflection() {
            data.weekly = {
                easy: document.getElementById('weeklyEasy').value,
                hard: document.getElementById('weeklyHard').value,
                plan: document.getElementById('weeklyPlan').value
            };
            save();
            alert('ì´ë²ˆ ì£¼ ìƒê°ì´ ì €ì¥ëì–´! ğŸ‘');
        }
        
        function sendWeeklyEmail() {
            // Ensure data structure exists
            if (!data.weekly) data.weekly = {};
            if (!data.weekend) data.weekend = [];
            if (!data.routines) data.routines = {};
            
            // Calculate summary
            let greenCount = 0;
            let yellowCount = 0;
            let routineDetails = [];
            
            const routineNames = {
                'english': 'ğŸ“š ì˜ì–´ë„ì„œê´€',
                'math': 'ğŸ”¢ í•€ë€ë“œìˆ˜í•™',
                'hanja': 'âœï¸ í•œì/ì—°ì‚°',
                'ort': 'ğŸ§ ORT ì²­ë…',
                'reading': 'ğŸ“– ì±… ì½ê¸°',
                'ringfit': 'ğŸ® ë§í•'
            };
            
            // Count and detail each routine
            Object.entries(data.routines).forEach(([key, state]) => {
                if (state === 'checked') greenCount++;
                if (state === 'circle') yellowCount++;
            });
            
            // Build routine details
            Object.keys(routineNames).forEach(id => {
                let daysCompleted = [];
                let daysPartial = [];
                
                days.forEach(day => {
                    const state = data.routines[id + '-' + day];
                    if (state === 'checked') daysCompleted.push(day);
                    if (state === 'circle') daysPartial.push(day);
                });
                
                if (daysCompleted.length > 0 || daysPartial.length > 0) {
                    let detail = routineNames[id] + ': ';
                    if (daysCompleted.length > 0) detail += 'âœ… ' + daysCompleted.join(',') + ' ';
                    if (daysPartial.length > 0) detail += 'â­• ' + daysPartial.join(',');
                    routineDetails.push(detail);
                }
            });
            
            // Get current week dates
            const today = new Date();
            const weekStr = `${today.getMonth() + 1}ì›” ${today.getDate()}ì¼ ì£¼`;
            
            // Build email content
            const subject = `[ë£¨í‹´í‘œ] ${weekStr} ê¸°ë¡`;
            const body = `ì•ˆë…•í•˜ì„¸ìš”!

ì´ë²ˆ ì£¼ ë£¨í‹´ ê¸°ë¡ì„ ë³´ë‚´ë“œë¦½ë‹ˆë‹¤.

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“Š ì´ë²ˆ ì£¼ ìš”ì•½
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

âœ… ì´ˆë¡ ì²´í¬: ${greenCount}ê°œ
â­• ë…¸ë€ ë™ê·¸ë¼ë¯¸: ${yellowCount}ê°œ
ğŸ“ˆ ì´ ì„±ê³µ: ${greenCount + yellowCount}ê°œ

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“ ë£¨í‹´ë³„ ì„¸ë¶€ ë‚´ì—­
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

${routineDetails.length > 0 ? routineDetails.join('\n') : 'ê¸°ë¡ ì—†ìŒ'}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸŒˆ ì£¼ë§ í™œë™
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

í† ìš”ì¼ íŠ¹ë³„ í™œë™: ${data.weekend && data.weekend.length > 0 ? data.weekend.join(', ') : 'ì„ íƒ ì•ˆ í•¨'}
ì¼ìš”ì¼ ë¸Œë¦¿ì§€: ${data.bridge || 'ì„ íƒ ì•ˆ í•¨'}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ’­ ì´ë²ˆ ì£¼ í•œ ë§ˆë””
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ì œì¼ ì‰¬ì› ë˜ ê²ƒ: ${data.weekly.easy || '-'}
í˜ë“¤ì—ˆë˜ ê²ƒ: ${data.weekly.hard || '-'}
ë‹¤ìŒ ì£¼ ì‘ì „: ${data.weekly.plan || '-'}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

â­•ê°€ ìˆì–´ë„ ì„±ê³µì…ë‹ˆë‹¤! 
ì˜ í•˜ê³  ìˆì–´ìš” ğŸ’š
`;
            
            // Create mailto link
            const mailtoLink = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            
            // Open email app
            window.location.href = mailtoLink;
        }
        
        function saveMonthlyGrowth() {
            data.monthly = {
                easier: document.getElementById('monthlyEasier').value,
                newSkill: document.getElementById('monthlyNew').value,
                tip: document.getElementById('monthlyTip').value
            };
            save();
            alert('ì´ë²ˆ ë‹¬ ì„±ì¥ ê¸°ë¡ì´ ì €ì¥ëì–´! ğŸŒ±');
        }
        
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js').catch(() => {});
            });
        }
        
        load();
        render();
    </script>
</body>
</html>
